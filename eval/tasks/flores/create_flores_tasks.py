#!/usr/bin/env python3
"""
Script to generate FLORES task YAML files for new languages.
Based on the lm-evaluation-harness standard structure.

Usage:
    python create_flores_tasks.py --source_lang en --target_lang ny --source_name English --target_name Chichewa
    python create_flores_tasks.py --source_lang fr --target_lang ny --source_name French --target_name Chichewa
    python create_flores_tasks.py --source_lang fr --target_lang ny --source_name French --target_name Chichewa --bidirectional
"""

import argparse
import os
from pathlib import Path


def create_task_yaml(source_lang, target_lang, source_name, target_name, output_dir):
    """Create a single directional FLORES task YAML file."""
    
    task_name = f"flores_{source_lang}_{target_lang}"
    filename = f"{task_name}.yaml"
    
    # Map language codes to FLORES field names
    lang_to_field = {
        'en': 'sentence_eng_Latn',
        'ny': 'sentence_nya_Latn',
        'fr': 'sentence_fra_Latn',
        'de': 'sentence_deu_Latn',
        'es': 'sentence_spa_Latn',
        'pt': 'sentence_por_Latn',
        'sw': 'sentence_swh_Latn',
        'zu': 'sentence_zul_Latn',
        'yo': 'sentence_yor_Latn',
        'ig': 'sentence_ibo_Latn',
        'ha': 'sentence_hau_Latn',
        'am': 'sentence_amh_Ethi',
        'ar': 'sentence_arb_Arab',
        'zh': 'sentence_zho_Hans',
        'hi': 'sentence_hin_Deva',
        'bn': 'sentence_ben_Beng',
        'ur': 'sentence_urd_Arab',
        'fa': 'sentence_pes_Arab',
        'tr': 'sentence_tur_Latn',
        'ru': 'sentence_rus_Cyrl',
        'ja': 'sentence_jpn_Jpan',
        'ko': 'sentence_kor_Hang',
        'th': 'sentence_tha_Thai',
        'vi': 'sentence_vie_Latn',
        'id': 'sentence_ind_Latn',
        'ms': 'sentence_zsm_Latn',
        'tl': 'sentence_tgl_Latn',
    }
    
    source_field = lang_to_field.get(source_lang, f'sentence_{source_lang}_Latn')
    target_field = lang_to_field.get(target_lang, f'sentence_{target_lang}_Latn')
    
    content = f"""# File generated by create_flores_tasks.py
include: _flores_common_yaml
task: {task_name}
doc_to_text: '{source_name} sentence: {{{{{source_field}}}}}

  {target_name} sentence:'
doc_to_target: '{{{{{target_field}}}}}'
"""
    
    filepath = output_dir / filename
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print(f"Created: {filepath}")
    return task_name


def create_bidirectional_yaml(source_lang, target_lang, source_name, target_name, output_dir):
    """Create a bidirectional FLORES task YAML file."""
    
    task_name = f"flores_{source_lang}_{target_lang}_bidirectional"
    filename = f"{task_name}.yaml"
    
    forward_task = f"flores_{source_lang}_{target_lang}"
    reverse_task = f"flores_{target_lang}_{source_lang}"
    
    content = f"""# File generated by create_flores_tasks.py
task: {task_name}
task_list:
  - {forward_task}
  - {reverse_task}
"""
    
    filepath = output_dir / filename
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print(f"Created: {filepath}")
    return task_name


def update_common_yaml_if_needed(output_dir):
    """Ensure _flores_common_yaml has the tag field."""
    common_yaml_path = output_dir / "_flores_common_yaml"
    
    if common_yaml_path.exists():
        with open(common_yaml_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        if not content.startswith('tag: flores'):
            print("Adding 'tag: flores' to _flores_common_yaml")
            content = 'tag: flores\n' + content
            with open(common_yaml_path, 'w', encoding='utf-8') as f:
                f.write(content)


def main():
    parser = argparse.ArgumentParser(description='Generate FLORES task YAML files for new languages')
    parser.add_argument('--source_lang', required=True, help='Source language code (e.g., en)')
    parser.add_argument('--target_lang', required=True, help='Target language code (e.g., ny)')
    parser.add_argument('--source_name', required=True, help='Source language name (e.g., English)')
    parser.add_argument('--target_name', required=True, help='Target language name (e.g., Chichewa)')
    parser.add_argument('--output_dir', default='.', help='Output directory (default: current directory)')
    parser.add_argument('--bidirectional', action='store_true', help='Create bidirectional task as well')
    parser.add_argument('--reverse', action='store_true', help='Also create reverse direction task')
    
    args = parser.parse_args()
    
    output_dir = Path(args.output_dir)
    output_dir.mkdir(exist_ok=True)
    
    # Update common YAML if needed
    update_common_yaml_if_needed(output_dir)
    
    # Create forward direction task
    forward_task = create_task_yaml(
        args.source_lang, args.target_lang, 
        args.source_name, args.target_name, 
        output_dir
    )
    
    tasks_created = [forward_task]
    
    # Create reverse direction task if requested
    if args.reverse or args.bidirectional:
        reverse_task = create_task_yaml(
            args.target_lang, args.source_lang,
            args.target_name, args.source_name,
            output_dir
        )
        tasks_created.append(reverse_task)
    
    # Create bidirectional task if requested
    if args.bidirectional:
        bidirectional_task = create_bidirectional_yaml(
            args.source_lang, args.target_lang,
            args.source_name, args.target_name,
            output_dir
        )
        tasks_created.append(bidirectional_task)
    
    print(f"\n‚úÖ Successfully created {len(tasks_created)} task(s):")
    for task in tasks_created:
        print(f"   - {task}")
    
    print(f"\nüìù To use these tasks, add them to your lm_eval_config.yaml:")
    for task in tasks_created:
        print(f"   - {task}")


if __name__ == "__main__":
    main()
